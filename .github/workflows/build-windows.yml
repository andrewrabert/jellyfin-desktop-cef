name: build-windows

on:
  workflow_dispatch:
  push:
    branches:
      - main
    tags:
      - 'v*'

env:
  MPV_VERSION: "20260118-git-468d34c"
  SDL_VERSION: "3.4.0"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: windows-latest
            platform: windows64
            mpv_arch: x86_64-v3
          - arch: arm64
            runner: windows-11-arm
            platform: windowsarm64
            mpv_arch: aarch64
    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Determine version
        id: version
        shell: bash
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION)
          else
            VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "0.0.0")
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Version: ${VERSION}"

      - name: Cache CEF
        uses: actions/cache@v4
        with:
          path: |
            third_party/cef
            third_party/cef_binary_*
          key: cef-windows-${{ matrix.arch }}-${{ hashFiles('dev/download_cef.py') }}
          restore-keys: |
            cef-windows-${{ matrix.arch }}-

      - name: Download CEF
        run: |
          python dev/download_cef.py --platform ${{ matrix.platform }}

      - name: Download SDL3
        shell: bash
        run: |
          curl -L "https://github.com/libsdl-org/SDL/releases/download/release-${SDL_VERSION}/SDL3-devel-${SDL_VERSION}-VC.zip" -o sdl3.zip
          7z x sdl3.zip -othird_party
          mv "third_party/SDL3-${SDL_VERSION}" third_party/SDL

      - name: Download libmpv
        shell: bash
        run: |
          # Preserve submodule headers (has render_vk.h), use prebuilt DLL
          mv third_party/mpv/include third_party/mpv-include
          rm -rf third_party/mpv
          mkdir -p third_party/mpv/lib
          mv third_party/mpv-include third_party/mpv/include
          curl -L "https://sourceforge.net/projects/mpv-player-windows/files/libmpv/mpv-dev-${{ matrix.mpv_arch }}-${MPV_VERSION}.7z/download" -o mpv.7z
          7z x mpv.7z -ompv-tmp
          mv mpv-tmp/libmpv-2.dll third_party/mpv/lib/
          # Generate .def file from DLL (package doesn't include it)
          cd third_party/mpv/lib
          gendef libmpv-2.dll

      - name: Install Vulkan SDK
        shell: pwsh
        run: |
          winget install KhronosGroup.VulkanSDK --accept-source-agreements --accept-package-agreements
          $sdkPath = Get-ChildItem "C:\VulkanSDK" | Sort-Object Name -Descending | Select-Object -First 1
          echo "VULKAN_SDK=$($sdkPath.FullName)" >> $env:GITHUB_ENV
          echo "$($sdkPath.FullName)\Bin" >> $env:GITHUB_PATH

      - name: Configure and build
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" ${{ matrix.arch }}
          cd third_party\mpv\lib
          lib /def:libmpv-2.def /out:mpv.lib /MACHINE:${{ matrix.arch == 'arm64' && 'ARM64' || 'X64' }}
          cd %GITHUB_WORKSPACE%
          cmake -B build -G Ninja ^
            -DCMAKE_BUILD_TYPE=RelWithDebInfo ^
            -DSDL3_DIR=%CD%\third_party\SDL\cmake ^
            -DEXTERNAL_MPV_DIR=%CD%\third_party\mpv
          cmake --build build

      - name: Create package
        shell: cmd
        run: |
          cmake --install build --prefix build/install
          cd build
          cpack -G ZIP

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}
          path: build/jellyfin-desktop-cef-*.zip
