name: build-macos

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15
            arch: arm64
          - runner: macos-15-intel
            arch: x86_64
    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Determine version
        id: version
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION)
          else
            VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "0.0.0")
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Version: ${VERSION}"

      - name: Install build tools
        run: |
          brew install cmake ninja meson

      - name: Install mpv dependencies
        run: |
          brew install \
            ffmpeg \
            libplacebo \
            libass \
            luajit \
            vulkan-loader \
            vulkan-headers \
            molten-vk \
            sdl3 \
            lcms2 \
            libunibreak \
            zimg

      - name: Cache CEF
        uses: actions/cache@v4
        with:
          path: |
            third_party/cef
            third_party/cef_binary_*
          key: cef-macos-${{ matrix.arch }}-${{ hashFiles('dev/download_cef.py') }}
          restore-keys: |
            cef-macos-${{ matrix.arch }}-

      - name: Download CEF
        run: |
          python3 dev/download_cef.py

      - name: Configure and build
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build

      - name: Create app bundle
        run: |
          APP_NAME="Jellyfin Media Player"
          APP_DIR="build/${APP_NAME}.app"
          CONTENTS_DIR="${APP_DIR}/Contents"
          MACOS_DIR="${CONTENTS_DIR}/MacOS"
          RESOURCES_DIR="${CONTENTS_DIR}/Resources"
          FRAMEWORKS_DIR="${CONTENTS_DIR}/Frameworks"

          # Create bundle structure
          mkdir -p "${MACOS_DIR}"
          mkdir -p "${RESOURCES_DIR}"
          mkdir -p "${FRAMEWORKS_DIR}"

          # Copy executable
          cp build/jellyfin-desktop-cef "${MACOS_DIR}/"

          # Copy CEF framework
          cp -R build/Frameworks/Chromium\ Embedded\ Framework.framework "${FRAMEWORKS_DIR}/"

          # Copy libmpv
          cp build/libmpv.2.dylib "${MACOS_DIR}/"

          # Create Info.plist from template
          VERSION="${{ steps.version.outputs.version }}"
          sed "s/@VERSION@/${VERSION}/g" resources/macos/Info.plist.in > "${CONTENTS_DIR}/Info.plist"

          # Copy icon if exists
          if [ -f resources/macos/AppIcon.icns ]; then
            cp resources/macos/AppIcon.icns "${RESOURCES_DIR}/"
          fi

          # Fix library paths for app bundle structure
          # Update executable to find framework in bundle
          install_name_tool -change \
            "@executable_path/Frameworks/Chromium Embedded Framework.framework/Chromium Embedded Framework" \
            "@executable_path/../Frameworks/Chromium Embedded Framework.framework/Chromium Embedded Framework" \
            "${MACOS_DIR}/jellyfin-desktop-cef"

          # Fix framework id for bundle location
          install_name_tool -id \
            "@executable_path/../Frameworks/Chromium Embedded Framework.framework/Chromium Embedded Framework" \
            "${FRAMEWORKS_DIR}/Chromium Embedded Framework.framework/Chromium Embedded Framework"

      - name: Bundle brew dependencies for libmpv
        run: |
          APP_NAME="Jellyfin Media Player"
          MACOS_DIR="build/${APP_NAME}.app/Contents/MacOS"
          FRAMEWORKS_DIR="build/${APP_NAME}.app/Contents/Frameworks"

          # Get list of dylibs that libmpv depends on (excluding system libs)
          echo "Analyzing libmpv dependencies..."
          otool -L "${MACOS_DIR}/libmpv.2.dylib" | grep -v '/System/' | grep -v '/usr/lib/' | grep -v '@' | awk '{print $1}' > /tmp/mpv_deps.txt

          # Copy each dependency and fix paths
          mkdir -p "${FRAMEWORKS_DIR}"
          while IFS= read -r dep; do
            if [ -f "$dep" ]; then
              depname=$(basename "$dep")
              echo "Bundling: $depname"
              cp "$dep" "${FRAMEWORKS_DIR}/"
              chmod 755 "${FRAMEWORKS_DIR}/${depname}"

              # Fix the dependency reference in libmpv
              install_name_tool -change "$dep" "@executable_path/../Frameworks/${depname}" "${MACOS_DIR}/libmpv.2.dylib"

              # Fix the library's own id
              install_name_tool -id "@executable_path/../Frameworks/${depname}" "${FRAMEWORKS_DIR}/${depname}"
            fi
          done < /tmp/mpv_deps.txt

          # Recursively fix dependencies of dependencies (2 levels deep should suffice)
          for lib in "${FRAMEWORKS_DIR}"/*.dylib; do
            [ -f "$lib" ] || continue
            libname=$(basename "$lib")
            echo "Fixing transitive deps for: $libname"
            otool -L "$lib" | grep -v '/System/' | grep -v '/usr/lib/' | grep -v '@' | awk '{print $1}' | while IFS= read -r dep; do
              if [ -f "$dep" ]; then
                depname=$(basename "$dep")
                if [ ! -f "${FRAMEWORKS_DIR}/${depname}" ]; then
                  echo "  Bundling transitive: $depname"
                  cp "$dep" "${FRAMEWORKS_DIR}/"
                  chmod 755 "${FRAMEWORKS_DIR}/${depname}"
                  install_name_tool -id "@executable_path/../Frameworks/${depname}" "${FRAMEWORKS_DIR}/${depname}"
                fi
                install_name_tool -change "$dep" "@executable_path/../Frameworks/${depname}" "$lib"
              fi
            done
          done

          # Second pass for any remaining transitive deps
          for lib in "${FRAMEWORKS_DIR}"/*.dylib; do
            [ -f "$lib" ] || continue
            otool -L "$lib" | grep -v '/System/' | grep -v '/usr/lib/' | grep -v '@' | awk '{print $1}' | while IFS= read -r dep; do
              if [ -f "$dep" ]; then
                depname=$(basename "$dep")
                if [ ! -f "${FRAMEWORKS_DIR}/${depname}" ]; then
                  echo "  Bundling (pass 2): $depname"
                  cp "$dep" "${FRAMEWORKS_DIR}/"
                  chmod 755 "${FRAMEWORKS_DIR}/${depname}"
                  install_name_tool -id "@executable_path/../Frameworks/${depname}" "${FRAMEWORKS_DIR}/${depname}"
                fi
                install_name_tool -change "$dep" "@executable_path/../Frameworks/${depname}" "$lib"
              fi
            done
          done

      - name: Ad-hoc sign
        run: |
          APP_NAME="Jellyfin Media Player"
          codesign --force --deep -s - "build/${APP_NAME}.app"

      - name: Create DMG
        run: |
          brew install create-dmg
          APP_NAME="Jellyfin Media Player"
          VERSION="${{ steps.version.outputs.version }}"
          ARCH="${{ matrix.arch }}"
          DMG_NAME="JellyfinMediaPlayer-${VERSION}-macos-${ARCH}.dmg"

          # create-dmg returns non-zero if icon positioning fails (no icon), ignore that
          create-dmg \
            --volname "Jellyfin Media Player v${VERSION}" \
            --no-internet-enable \
            --window-size 500 300 \
            --icon-size 100 \
            --icon "${APP_NAME}.app" 125 150 \
            --app-drop-link 375 150 \
            "${DMG_NAME}" "build/${APP_NAME}.app" || true

          # Verify DMG was created
          if [ ! -f "${DMG_NAME}" ]; then
            echo "DMG creation failed"
            exit 1
          fi
          echo "Created: ${DMG_NAME}"
          ls -la "${DMG_NAME}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: JellyfinMediaPlayer-*.dmg
